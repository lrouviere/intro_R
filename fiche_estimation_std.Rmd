---
title: "La moyenne empirique"
output:
  html_notebook:
    toc: true
    toc_float: true
---

<style type="text/css">

body{ /* Normal  */
      font-size: 12px;
  }
td {  /* Table  */
  font-size: 12px;
}
h1.title {
  font-size: 48px;
  color: DarkRed;
}
h1 { /* Header 1 */
  font-size: 35px;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 28px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 24px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>




Dans cette partie nous allons construire des échantillons par simulation et nous intéresser à l'étude de la moyenne de ces échantillons.

## Générer des observations selon des lois de probabilités

**R** étant un logiciel de statistique, il est bien entendu possible de 

* visualiser 
* calculer des quantiles
* générer des observations

pour toutes les lois classiques de probabilités. Chaque loi va être identifiée par une chaine de caractères :

Loi | Chaine 
----|------
Binomiale | binom
Poisson | pois 
Uniforme | unif
Exponentielle | exp
Normale | norm



Un préfixe permettra de spécifier l'action que l'on souhaite effectuer sur la loi :

* **d** : calculer la densité pour une loi continue ou la fonction de masse pour une loi discrète
* **q** : calculer les quantiles
* **r** : générer des observations.

On pourra par exemple :

* Calculer la densité de la loi $\mathcal N(0,1)$ en -1,0,1 avec
```{r}
dnorm(c(-1,0,1),mean=0,sd=1)
```

* Calculer les quantiles d'ordre 0.05, 0.5 et 0.95 de la loi $\mathcal N(0,1)$ en -1,0,1 avec

```{r}
qnorm(c(0.05,0.5,0.95),mean=0,sd=1)
```


* Générer 10 observations selon une loi $\mathcal N(0,1)$ avec

```{r}
rnorm(10,mean=0,sd=1)
```


### Exercice 1

1. Soit $X$ un variable de loi binomiale $B(20,0.6)$. Calculer la probabilité que $X$ soit égale à 1,5,10,15.


2. Représenter le diagramme en barre associé à la loi $B(20,0.6)$. On pourra utiliser l'argument **stat="identity"** dans la fonction **geom_bar**.


3. Générer un échantillon de taille 5000 selon la loi $B(20,0.6)$. Tracer le diagramme en barres associé à cet échantillon et comparer le à celui de la question précédente.


### Exercice 2

1. Tracer la densité de la loi $\mathcal N(0,1)$.


2. Générer un échantillon de taille 5000 selon la loi $\mathcal N(0,1)$. Tracer l'histogramme associé à cet échantillon et comparer le à la densité tracée à la question précédente (on pourra supperposer les 2 représentations).



## Une étude numérique de la moyenne empirique.

On s'intéresse dans cette partie à l'étude de la moyenne empirique 
$$\bar x_n=\frac{1}{n}\sum_{i=1}^nx_i$$
d'un échantillon i.i.d $x_1,\dots,x_n$. Remarquons déjà que la moyenne empirique dépend des observations $x_1,\dots,x_n$ : la moyenne va donc changer lorsque les observations changent.

### Exemple. 

On considère deux échantillons de taille 20 générées selon une loi uniforme entre 0 et 1 :
```{r}
ech1 <- runif(20)
ech2 <- runif(20)
df <- data.frame(ech1,ech2)
```
Les moyennes empiriques pour ces deux échantillons sont différentes :

```{r}
df %>% summarise_all(mean)
```

Ainsi la moyenne empirique peut-être considérée comme une variable aléatoire : elle va donc posséder une loi de probabilité, une espérance... Si on considère l'exemple précédent, on sent bien que la distribution de la moyenne empirique doit 

* se répartir autours de 0.5 (qui est la valeur à estimer).
* être de plus en plus concentrée autours de 0.5 lorsque le nombre d'observations $n$ augmente.

On peut visualiser ce fait en 

1. générant nombre $B$ (grand) d'échantillons  de taille $n=20$ selon une loi uniforme entre 0 et 1.

```{r}
set.seed(1234)
df <- matrix(runif(20*5000),nrow=20) %>% as.data.frame()
```

2. calculant les moyennes obtenues pour chaque échantillon

```{r}
moy <- df %>% summarize_all(mean)
head(t(moy))
```


3. visualisant la distribution de la moyenne de chaque échantillon (en traçant l'histogramme de ces valeurs par exemple).
```{r}
moy <- data.frame(M=t(moy))
ggplot(moy)+aes(x=M,y=..density..)+geom_histogram(bins=20)+theme_classic()
```


Le thérème centrale limite nous dit que cette moyenne $\bar X_n$ vérifie
$$\sqrt{n}\frac{\bar X_n-\mu}{\sigma}\to \mathcal N(0,1)$$
avec $\mu=0.5$ et $\sigma=1/\sqrt{12}$ ici. On a donc
$$\sqrt{n}\frac{\bar X_n-0.5}{1/\sqrt{12}}\to \mathcal N(0,1)$$
Ce qui veut dire qu'on peut approcher la loi de $\bar X_n$ par la loi $\mathcal N(0.5,1/(12n))$ avec $n=20$.
```{r}
x <- seq(0.25,0.75,by=0.001)
df <- data.frame(x=x,y=dnorm(x,0.5,1/(sqrt(12*20))))
ggplot(moy)+aes(x=M,y=..density..)+geom_histogram(bins=20)+
  geom_line(data=df,aes(x=x,y=y),color="red",size=2)+theme_classic()+xlab("x")

```


### Exercice 3

Faire le même travail pour des tailles d'échantillon de 50, 100 et 500. Interpréter.



### Exercice 4

Faire le même exercice pour une loi gaussienne $\mathcal N(1,2)$ et une loi de Bernoulli $\mathcal B(0.6)$.


* Pour la $\mathcal B(0.6)$


## Intervalles de confiance

On cherche ici à illustrer numériquement le niveau d'un intervalle de confiance. On rappelle que $[A,B]$ est un IC de niveau $1-\alpha$ pour un paramètre $\theta$ si
$$P(\theta\in[A,B])=1-\alpha.$$

### Exercice 5

On fixe ici le niveau à 0.95 ($\alpha=0.05$). On considère $n$ observations $x_1,\dots,x_n$ i.i.d de loi $\mathcal N(\mu,1)$ et on cherche un intervalle de confiane pour $\mu$.

1. Générer $n=100$ observations i.i.d. selon la loi $\mathcal N(\mu,1)$ avec $\mu=1$.


2. Calculer un intervalle de confiance pour $\mu$ de niveau 0.95.

3. Selon-vous, peut-on dire que la probabilité que $\mu$ appartienne à l'intervalle trouvé est de 0.95 ? Si non, comment peut-on interpréter cette formule.


4. Générer 5000 échantillons i.i.d. de loi $\mathcal N(1,1)$ de tailles 100. On pourra mettre le tout dans une matrice de taille 5000*100.


5. Calculer un intervalle de confiance de niveau 0.95 pour chacun des 5000 échantillons. On pourra utiliser une boucle **for** ou la fonction **apply**.


6. Sur les 5000 intervalles obtenus, calculer le nombre de fois où la vraie valeur de $\mu$ (en l'occcurence ici 1) se trouve à l'intérieur de l'intervalle.


7. Refaire les questions 5-6-7 avec des IC de niveau 0.90.



### Exercice 6


On considère les données sur les iris de Fisher. Constuire un intervalle de confiance de niveau 90% pour les paramètres suivants :

  + La longueur de Pétales moyenne
  
  + La largeur de Sépales moyenne de l'espèce Setosa
    
  + La largeur de Sépales moyenne des espèces Versicolor et Virginica



### Exercice 7

On considère $x_1,\dots,x_n$ un échantillon i.i.d issu d'une loi de Bernoulli de paramètre $p\in[0,1]$ inconnu.

1. Proposer un estimateur $\widehat p$ pour $p$.

On peut prendre 
$$\widehat p=\bar x_n=\frac{1}{n}\sum_{i=1}^nx_i.$$
2. A l'aide du TCL, obtenir la loi asymptotique de $\hat p$.

On a d'après la TCL

$$\sqrt{n}\frac{\widehat{p}-p}{\sqrt{p(1-p)}}\stackrel{\mathcal L}{\to}\mathcal N(0,1)$$

3. En déduire un intervalle de confiance de niveau $1_\alpha$ pour $p$. 

On déduit que
$$\left[\widehat p-q_{1-\alpha/2}\sqrt{\frac{p(1-p)}{n}}, \widehat p+q_{1-\alpha/2}\sqrt{\frac{p(1-p)}{n}}\right].$$

est un IC de niveau $1-\alpha$.

4. Que pouvez-vous reprocher à l'intervalle proposé à la question précédente ?

L'IC proposé dépend de $p$ qui est inconnu ! Il ne sera donc pas calculable en pratique !

5. Proposer une solution.

Un solution classique consiste à remplacer le paramètre $p$ inconnu par son estimateur $\widehat p$. On obtient ainsi l'IC

$$\left[\widehat p-q_{1-\alpha/2}\sqrt{\frac{\widehat p(1-\widehat p)}{n}}, \widehat p+q_{1-\alpha/2}\sqrt{\frac{\widehat p(1-\widehat p)}{n}}\right].$$


### Exercice 8

Afin de tenter de deviner qui va gagner une élection entre deux candidats $A$ et $B$ on effectue un sondage. On demande à 100 personnes pour qui elles vont voter. Les résultats sont reportés dans le vecteur suivant.

```{r}
set.seed(12345)
res <- rbinom(100,1,0.52)
```

On désigne par $p$ la propotion (inconnue) d'électeurs qui vont voter pour $A$.

1. Proposer et calculer un estimateur de $p$.


2. Que pouvez-vous conclure a priori.


3. En vous basant sur l'exercice précédent, calculer un intervalle de confiance de niveau 95% pour $p$.


4. Est-ce que l'intervalle obtenu  conforte votre conclusion de la question 2 ?


5. Calculer un intervalle de confiance pour $p$ à l'aide de la fonction **prop.test**.


### Exercice 9 : comparer des moyennes

On considère les données **decathlon** suivantes.

```{r message=FALSE, warning=FALSE}
library(FactoMineR)
data(decathlon)
```

On souhaite comparer les performances au 100m en fonction de la compétition (Decastar vs JO).

1. Calculer un intervalle de confiance de niveau 95% pour la vitesse moyenne au 100m au Decastar.


2. Même question pour les jeux olympiques.


3. Pouvez-vous conclure sur la question posée ? Si non, que faire ?

